# BlueROV2 MPC
This work implements a NMPC controller for BlueROV2 with ROS.

## Prerequisites
* Python 3.7
* ROS ([ROS noetic](http://wiki.ros.org/noetic/Installation/Ubuntu) recommended)
* [uuv simulator](https://uuvsimulator.github.io/)
* [MAVROS](http://wiki.ros.org/mavros)
* [Acados](https://docs.acados.org/installation/index.html)

## Getting started
Install python 3.7
```
sudo add-apt-repository ppa:deadsnakes/ppa
sudo apt update
sudo apt install python3.7
```
Install python dependencies
```
python3 -m pip install pip
pip3 install numpy matplotlib scipy future-fstrings casadi>=3.5.1 setuptools
sudo apt-get install python3.7-tk
```
Install Acados
```
git clone https://github.com/acados/acados.git
cd acados
git submodule update --recursive --init
mkdir -p build
cd build
cmake -DACADOS_WITH_QPOASES=ON -DACADOS_WITH_OSQP=OFF/ON -DACADOS_INSTALL_DIR=<path_to_acados_installation_folder> ..
make install -j4
```
Create a catkin workspace and clone uuv simulator package to catkin src folder (ex. ~/catkin_ws/src)
```
mkdir -p ~/catkin_ws/src
cd ~/catkin_ws/
catkin_make
cd src
sudo apt install ros-kinetic-uuv-simulator	(for ros kinetic)
sudo apt install ros-lunar-uuv-simulator	(for ros lunar)
sudo apt install ros-melodic-uuv-simulator	(for ros melodic)
git clone --branch noetic https://github.com/arturmiller/uuv_simulator.git	(for ros noetic)
```
Clone this package to catkin src folder
```
cd ~/catkin_ws/src
git clone https://github.com/HKPolyU-UAV/bluerov2.git
```
Install acados_template python packages
```
pip install -e <acados_root>/interfaces/acados_template
```
Add the path to the compiled shared libraries (Hint: you can add these lines to your ```.bashrc``` by ```sudo gedit ~/.bashrc```)
```
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:"<acados_root>/lib"
export ACADOS_SOURCE_DIR="<acados_root>"
```
Modify <acados_root> path (18th and 19th lines) in CMakeLists
```
cd ~/catkin_ws/src/bluerov2/bluerov2_mpc
gedit CMakeLists.txt
```
Generate C code for NMPC controller
```
cd scripts
python generate_c_code.py
```
Compile
```
cd ~/catkin_ws
catkin_make
```

## Start simulation without controller
Ocean_waves in uuv simulator is set as default world.

Quick start to initialize the Gazebo world and add blueROV2 vehicle
```
roslaunch bluerov2_gazebo quick_start.launch
```
Or start with thruster manager
```
roslaunch bluerov2_gazebo start_with_thruster_manager.launch
```
With thruster manager, forces and moments can be published to topic /bluerov2/thruster_manager/input.

## Start simulation with PID controller
Start PID controller with teleop (using joystick)
```
roslaunch bluerov2_gazebo start_pid_demo_with_teleop.launch
```
Or start PID Controller without teleop
```
roslaunch bluerov2_gazebo start_pid_demo.launch
```

Further trajectory tracking tasks can be done with uuv_control_utils package, such as following linear trajectory
```
roslaunch uuv_control_utils send_waypoints_file.launch uuv_name:=bluerov2 interpolator:=linear
```
Or following helical trajectory
```
roslaunch uuv_control_utils start_helical_trajectory.launch uuv_name:=bluerov2 n_turns:=2
```

## Start simulation with MPC controller
A demonstration of starting MPC controler to follow circular trajectory can be launched by
```
roslaunch bluerov2_gazebo start_mpc_demo.launch
```
The bluerov2_mpc package also includes more trajectory following tasks such as following leminscate path and self defined waypoints.

## Disturbance generator
The uuv simulator provides [disturbance generation functions](https://uuvsimulator.github.io/packages/uuv_simulator/docs/tutorials/disturbances/) for testing the vehicle.

A demonstration of starting simulation with random current disturbances can be launched by
```
roslaunch bluerov2_gazebo start_pid_with_current.launch    (with PID controller)
roslaunch bluerov2_gazebo start_mpc_with_current.launch    (with MPC controller)
```
Disturbances can also be generated by using ROS service call
```
rosservice call /hydrodynamics/set_current_velocity_model "{mean: 0.0, min: 0.0, max: 0.0, noise: 0.0, mu: 0.0}"
rosservice call /hydrodynamics/set_current_horz_angle_model "{mean: 0.0, min: 0.0, max: 0.0, noise: 0.0, mu: 0.0}"
rosservice call /hydrodynamics/set_current_vert_angle_model "{mean: 0.0, min: 0.0, max: 0.0, noise: 0.0, mu: 0.0}"
```